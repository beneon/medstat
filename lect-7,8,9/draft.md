# lect.7 卡方检验


## 单样本离散因变量的假设检验

### 卡方检验待检验假设与统计量

对k个类别来说, ($\hat{p_1}, \hat{p_2}, ..., \hat{p_k}$)是各个类别从样本观察到的概率, 而($p_1, p_2, ..., p_k$)则是k个类别的实际概率, 则零假设为:

H0: $p_1=p_{10}, p_2=p_{20}, ..., p_k=p_{k0}$

此时的统计量:卡方值的计算公式是

$\chi = \sum{\frac{(O-E)^2}{E}}$

卡方值比较的是观察值和期望值之间的差的平方,与期望值的比值. 观察值越符合期望值, 这个比值越小.

### 实例

1. 某大学去年对在读学生进行健康调查, 问卷结果提示其中60%的学生没有规律锻炼, 25%偶尔有锻炼, 15%的学生规律锻炼. 随后学校开展了健康促进宣传活动. 一年以后再次做了问卷调查, 访问了470名学生, 得到了下表的结果

分组 | 无规律锻炼 | 偶尔锻炼 | 规律锻炼 | 总数
------- | ------- | ------- | ------- | -------
学生数 | 255 |125 |90 | 470

根据上面的数据, 是否能说明开展了健康宣传促进活动以后, 学生对问卷的回答的分布发生了变化?

像这种评价一个样本里面各类别数量分布是否"符合"一个已知分布的检验,叫做$\chi^2$ goodness of fit检验. 检验的是样本因变量的分布是否"符合"一个特定的分布规律.

### 假设检验5步

1. 确定假设和检验水平

H0: 分布没有变化, 所以今年各类比例和去年的比例是一样的, 也就是$p_1=0.6, p_2=0.25, p_3=0.15$. 

或者

$p_{1}=p_{10}, p_{2}=p_{20},...,p_{k}=p_{k0}$

H1: H0是错的, $\alpha$=0.05


2. 选择统计量

使用卡方值作为统计量($\chi^2 = \sum{\frac{(O-E)^2}{E}}$), 首先要确定符合以下的条件:

 1. n大于等于40
 2. $n \times p_{10}, n\times p_{20},..., n \times p_{k0}$均大于等于5
 3. 如n大于等于40, $n \times p_{10}, n\times p_{20},..., n \times p_{k0}$小于5且大于等于1, 使用连续性矫正的卡方公式: $\chi^2=\sum{\frac{(|O-E|-0.5)^2}{E}}$
 4. 如果n小于40,或者$min(n \times p_{10}, n\times p_{20},..., n \times p_{k0})$小于1的时候不宜计算卡方值, 而是采用Fisher确切概率法


在本例里面上面条件都满足.

3. 确定判定标准

这个例子里, 自由度d.f.=k-1, (k是组数). 本例自由度是2, 查找自由度是2, 检验水平是0.05的卡方临界值, 得到5.99

4. 计算统计量

分组 | 无规律锻炼 | 偶尔锻炼 | 规律锻炼 | 总数
------- | ------- | ------- | ------- | -------
观察频数 | 255 |125 |90 | 470
期望频数 | 470x0.6 | 470x0.25| 470x0.15|470

计算可得$\chi^2=8.46$

5. 结论

由于8.46大于5.99, 在0.05检测水平上可以拒绝零假设.

## 2组或多组计数边带独立样本的比较

[来源](http://sphweb.bumc.bu.edu/otlt/MPH-Modules/BS/BS704_HypothesisTesting-ChiSquare/BS704_HypothesisTesting-ChiSquare3.html)

单样本的时候, 卡方检验做的是拟合优度(观察到的数据和期望的数据的符合程度). 而在2组或以上的独立样本的时候, 如果我们要比较不同组的计数因变量的分布是否有区别的时候, 我们可以把卡方检验的应用做一个扩展, 这个时候叫做独立性卡方检验. 

独立性卡方检验的典型H0可以如下描述:分组如何与因变量的分布是相互独立的. 而被择假设就是不同组因变量的分布有所不同(因变量分布和分组是相关的). 

什么是独立呢? 如果用数学公式来表示的话, A和B, 如果:

$P(A|B)=P(A)$, or $P(A \bigcap B)=P(A)P(B)$

由第二个式子可以得到,如果A和B是相互独立的, 那么A和B同时发生($P(A\bigcap B)$)的概率就是$P(A)P(B)$

所以根据零假设, 则有某一组(比如1组)因变量的某个值(比如因变量值1)的概率应该是

$P(G1\bigcap R1)=P(G1)P(R1)$

比如我们考虑下面一个表

x | r1 | r2 | r3 | 总共
------- | ------- | ------- | ------- | -------
g1 | 10 | 8 | 7 | 25
g2 | 22 | 15 | 13 | 50
g3 | 30 | 28 | 17 | 75
总共 |62| 51 | 37 | 150

从这个表里可以看到$P(r1)=\frac{62}{150}$, $P(g1)=\frac{25}{150}$, 所以

$P(g1 \bigcap r1)=P(r1)\times P(g1)=\frac{n_r}{n_T} \times \frac{n_c}{n_T}=\frac{62}{150} \times \frac{25}{150}$

概率乘以总样本量$n_T$就是g1,r1这个格子的期望频数(E):10.33

所以某个格子的期望频数:

$E_{rc}=n_r*n_c/n_T$

上面的式子是一步到位, 直接计算频数

### 实例

在单样本的那个实例里面, 我们考察了全校学生锻炼的情况. 下面这个研究调查了470名毕业生. 除了调查他们的锻炼频率, 还调查了他们居住的情况,有下表:

x | 没有规律锻炼 | 偶尔锻炼 | 规律锻炼 | 总体
------- | ------- | ------- | ------- | -------
宿舍 | 32 | 30 | 28 | 90
校内公寓 | 74 | 64 | 42 | 180
校外公寓 | 110| 25 | 15 | 150
家里 | 39 | 6 | 5 | 50
总体 | 255 |125 |90 | 470

根据这些数据, 能否认为一个学生的居住情况和他的锻炼频率有关呢?

1. 确定假设和检验水平

H0: 居住情况和锻炼频率彼此独立, 备择假设: 居住情况和锻炼频率彼此不独立. $\alpha$=0.05

2. 选择恰当的统计量

参考:

 1. n大于等于40
 2. $n \times p_{10}, n\times p_{20},..., n \times p_{k0}$均大于等于5
 3. 如n大于等于40, $n \times p_{10}, n\times p_{20},..., n \times p_{k0}$小于5且大于等于1, 使用连续性矫正的卡方公式: $\chi^2=\sum{\frac{(|O-E|-0.5)^2}{E}}$
 4. 如果n小于40,或者$min(n \times p_{10}, n\times p_{20},..., n \times p_{k0})$小于1的时候不宜计算卡方值, 而是采用Fisher确切概率法

各个格子的期望E都是大于5的, 所以可以用下式计算卡方值作为统计量

$\chi^2=\sum{\frac{(O-E)^2}{E}}$

3. 确定判定标准

本题数据的自由度:

$d.f. = (r-1)\times (c-1) = 2 \times 3=6$

查表可得$alpha=0.05, d.f.=6$的卡方临界值是12.59

4. 计算统计量

使用之前提到的公式计算频数:

$E=n_r*n_c/n_T$

5. 得出结论

60.5大于临界值12.59,拒绝零假设,接受备择假设

### 例题2

胰腺切除术是一个难度很高的手术, 围手术期并发症众多. 近期一个研究回顾分析了553例接受了胰腺切除术的患者, 试图评估他们的Apgar评分(SAS)是否后30天围手术期并发症/死亡存在关联

SAS | 无并发症 | 轻度并发症 | 重度并发症或死亡
------- | ------- | ------- | -------
0-4 | 21 | 20 | 16
5-6 | 135 | 71 | 35
7-10 | 158 | 62 | 35

请根据以上数据进行评价.

### 卡方检验和二项分布检验的关系-2

之前我们在做两组2分类变量比较的时候使用的是二项分布的正态近似检验. 实际上这种问题也属于计量变量的组间比较, 所以当然也可以用卡方检验来做.

某RCT实验比较新药和一线止痛药物的治疗效果. 治疗前和治疗后新药组与对照组都做了VAS评分, 研究者记录了VAS评分降低超过3个单位的个数, 如下表所示

治疗 | n | VAS降低超过3频数 | VAS降低超过3比例
------- | ------- | ------- | -------
新药 | 50 | 23 | 0.46
对照 | 50 | 11 | 0.22

####  使用正态分布近似方法

1. 确定统计假设和检验水平

H0: p1=p2, H1:p1 ≠ p2, $\alpha=0.05$

2. 选择合适的统计量

首先判断是否适合作正态分布近似

$min(n_1*\hat{p_1},n_1*(1-\hat{p_1}),n_2*\hat{p_2},n_2*(1-\hat{p_2}))\geq 5$

从数据可以看到：

治疗 | n | VAS降低超过3频数 | VAS降低小于等于3频数
------- | ------- | ------- | -------
新药 | 50 | 23 | 27
对照 | 50 | 11 | 39

所以4个格子（23，27，11，39）都是大于5的，因此可以做正态近似。（现在我们使用的是大于等于5这个标准，上一次课我们选用的是大于等于10的标准，10当然比5要更保险。）

也就是说统计量是：

$z=\frac{\hat{p_1}-\hat{p_2}}{\sqrt{\hat{p}(1-\hat{p})(\frac{1}{n_1}+\frac{1}{n_2})}}$

其中$\hat{p}=\frac{\hat{p_1}*n_1+\hat{p_2}*n_2}{n_1+n_2}$

3. 确定判断标准

如果z大于等于1.96或者小于等于-1.96就拒绝零假设

4. 计算统计量

2.53大于1.96，拒绝零假设

#### 卡方检验法

治疗 |  VAS降低超过3 | VAS降低小于等于3|总和
 ------- | ------- | -------|---
新药  | 23 | 27|50
对照  | 11 | 39|50
总和|44|66|100

1. 确定统计假设和检验水平

H0：治疗方法和疗效（疼痛较弱的情况）


## 配对2x2表的检验